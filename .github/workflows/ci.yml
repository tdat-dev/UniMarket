name: ğŸ” CI Pipeline

on:
  push:
    branches: ["main", "develop"]
  pull_request:
    branches: ["main", "develop"]

env:
  PHP_VERSION: "8.2"
  NODE_VERSION: "18"

jobs:
  # ============================================
  # JOB 1: PHP Lint + Code Quality
  # ============================================
  php-quality:
    name: ğŸ˜ PHP Quality Check
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ˜ Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          tools: composer:v2
          coverage: xdebug

      - name: ğŸ“¦ Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: vendor
          key: composer-${{ hashFiles('composer.lock') }}
          restore-keys: composer-

      - name: âœ… Validate composer.json
        run: composer validate --no-interaction

      - name: ğŸ“¥ Install dependencies
        run: composer install --no-interaction --prefer-dist --no-progress

      - name: ğŸ” Determine changed PHP files
        id: changed
        shell: bash
        run: |
          set -euo pipefail

          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            BASE="${{ github.event.pull_request.base.sha }}"
            HEAD="${{ github.event.pull_request.head.sha }}"
          else
            BASE="${{ github.event.before }}"
            HEAD="${{ github.sha }}"
          fi

          echo "Base: $BASE"
          echo "Head: $HEAD"

          {
            echo "files<<EOF"
            if [[ "$BASE" == "0000000000000000000000000000000000000000" ]]; then
              git diff-tree --no-commit-id --name-only -r "$HEAD" -- '*.php' ':!vendor/**' || true
            else
              git diff --name-only "$BASE" "$HEAD" -- '*.php' ':!vendor/**' || true
            fi
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: ğŸ§ª PHP Syntax Check
        shell: bash
        run: |
          set -euo pipefail
          FILES="${{ steps.changed.outputs.files }}"

          if [[ -z "$FILES" ]]; then
            echo "âœ… No PHP files changed. Skip syntax check."
            exit 0
          fi

          echo "ğŸ” Checking syntax for changed files..."
          while IFS= read -r f; do
            [[ -z "$f" ]] && continue
            if [[ -f "$f" ]]; then
              php -l "$f"
            else
              echo "â­ï¸ Skipping deleted file: $f"
            fi
          done <<< "$FILES"

      - name: ğŸ”’ Security Audit (Composer)
        run: composer audit --no-interaction
        continue-on-error: true

  # ============================================
  # JOB 2: Node.js Check (Chat Server)
  # ============================================
  node-quality:
    name: ğŸŸ¢ Node.js Quality Check
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: chat-server/package-lock.json

      - name: ğŸ“¥ Install dependencies
        working-directory: ./chat-server
        run: npm ci

      - name: ğŸ§ª Check for syntax errors
        working-directory: ./chat-server
        run: node --check index.js

      - name: ğŸ”’ Security Audit (npm)
        working-directory: ./chat-server
        run: npm audit --audit-level=high
        continue-on-error: true

  # ============================================
  # JOB 3: Security Scanning
  # ============================================
  security:
    name: ğŸ›¡ï¸ Security Scan
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript

      - name: ğŸ” Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: ğŸ›¡ï¸ Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

  # ============================================
  # JOB 4: Build Verification
  # ============================================
  build-check:
    name: ğŸ—ï¸ Build Verification
    runs-on: ubuntu-latest
    needs: [php-quality, node-quality]

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ˜ Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          tools: composer:v2

      - name: ğŸ“¦ Cache Composer
        uses: actions/cache@v4
        with:
          path: vendor
          key: composer-${{ hashFiles('composer.lock') }}

      - name: ğŸ“¥ Install PHP dependencies
        run: composer install --no-interaction --prefer-dist --no-progress --optimize-autoloader

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ“¥ Install Node dependencies
        working-directory: ./chat-server
        run: npm ci --production

      - name: âœ… Verify project structure
        run: |
          echo "ğŸ” Checking critical files..."
          test -f "public/index.php" && echo "âœ… public/index.php exists"
          test -f "composer.json" && echo "âœ… composer.json exists"
          test -f "chat-server/index.js" && echo "âœ… chat-server/index.js exists"
          test -d "app/Controllers" && echo "âœ… app/Controllers/ exists"
          test -d "app/Models" && echo "âœ… app/Models/ exists"
          echo "ğŸ‰ All critical files verified!"

  # ============================================
  # Summary
  # ============================================
  ci-summary:
    name: ğŸ“‹ CI Summary
    runs-on: ubuntu-latest
    needs: [php-quality, node-quality, security, build-check]
    if: always()

    steps:
      - name: ğŸ“Š Check job results
        run: |
          echo "========================================"
          echo "           CI PIPELINE SUMMARY          "
          echo "========================================"
          echo "PHP Quality:    ${{ needs.php-quality.result }}"
          echo "Node.js Quality: ${{ needs.node-quality.result }}"
          echo "Security Scan:  ${{ needs.security.result }}"
          echo "Build Check:    ${{ needs.build-check.result }}"
          echo "========================================"

          if [[ "${{ needs.php-quality.result }}" == "failure" ]] || \
             [[ "${{ needs.node-quality.result }}" == "failure" ]] || \
             [[ "${{ needs.build-check.result }}" == "failure" ]]; then
            echo "âŒ CI Pipeline FAILED!"
            exit 1
          else
            echo "âœ… CI Pipeline PASSED!"
          fi
